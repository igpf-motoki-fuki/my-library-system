 from flask import Flask, request
import sqlite3

app = Flask(__name__)

# 脆弱性を含むデータベース接続関数
def get_db_connection():
    conn = sqlite3.connect('test.db')
    conn.row_factory = sqlite3.Row
    return conn

# 脆弱性を含むユーザー検索関数
@app.route('/search_user', methods=['GET'])
def search_user():
    username = request.args.get('username')
    # 脆弱性: SQLインジェクションの可能性がある
    query = f"SELECT * FROM users WHERE username = '{username}'"
    
    conn = get_db_connection()
    result = conn.execute(query).fetchall()
    conn.close()
    
    return {'users': [dict(row) for row in result]}

# 脆弱性を含むユーザー認証関数
@app.route('/login', methods=['POST'])
def login():
    username = request.form.get('username')
    password = request.form.get('password')
    
    # 脆弱性: パスワードが平文で保存・比較される
    conn = get_db_connection()
    query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
    user = conn.execute(query).fetchone()
    conn.close()
    
    if user:
        return {'message': 'Login successful'}
    return {'message': 'Login failed'}, 401

if __name__ == '__main__':
    app.run(debug=True)